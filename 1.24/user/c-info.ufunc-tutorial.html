
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Writing your own ufunc &#8212; NumPy v1.24 Manual</title>
<script>
  document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
  document.documentElement.dataset.theme = localStorage.getItem("theme") || "light"
</script>

  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=92025949c220c2e29695" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=92025949c220c2e29695" rel="stylesheet">


  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/numpy.css" />

  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/design-tabs.js"></script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Beyond the Basics" href="c-info.beyond-basics.html" />
    <link rel="prev" title="Using Python as glue" href="c-info.python-as-glue.html" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="light">
    <div class="bd-header-announcement container-fluid" id="banner">
      

    </div>

    
    <nav class="bd-header navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="bd-header__inner container-xl">

  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    <img src="../_static/numpylogo.svg" class="logo__image only-light" alt="Logo image">
    <img src="../_static/numpylogo_dark.svg" class="logo__image only-dark" alt="Logo image">
  
  
</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="fas fa-bars"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="index.html">
  User Guide
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../reference/index.html">
  API reference
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../dev/index.html">
  Development
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../release.html">
  Release notes
 </a>
</li>

    
    <li class="nav-item">
        <a class="nav-link nav-external" href="https://numpy.org/numpy-tutorials/">Learn<i class="fas fa-external-link-alt"></i></a>
    </li>
    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <span id="theme-switch" class="btn btn-sm btn-outline-primary navbar-btn rounded-circle">
    <a class="theme-switch" data-mode="light"><i class="fas fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="far fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fas fa-adjust"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        1.24  <!-- this text may get changed later by javascript -->
        <span class="caret"></span>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables user/c-info.ufunc-tutorial and {'version_match': '1.24', 'json_url': 'https://numpy.org/doc/_static/versions.json'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "user/c-info.ufunc-tutorial.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://numpy.org/doc/_static/versions.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "user/c-info.ufunc-tutorial.html";
        let btn = document.getElementById("version_switcher_button");
        // Set empty strings by default so that these attributes exist and can be used in CSS selectors
        btn.dataset["activeVersionName"] = "";
        btn.dataset["activeVersion"] = "";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 1.24 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "1.24") {
                node.classList.add("active");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/numpy/numpy" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/numpy_team" rel="noopener" target="_blank" title="Twitter"><span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="bd-container container-xl">
      <div class="bd-container__inner row">
          

<!-- Only show if we have sidebars configured, else just a small margin  -->
<div class="bd-sidebar-primary col-12 col-md-3 bd-sidebar">
  <div class="sidebar-start-items"><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Getting started
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="whatisnumpy.html">
   What is NumPy?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://numpy.org/install/">
   Installation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="quickstart.html">
   NumPy quickstart
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="absolute_beginners.html">
   NumPy: the absolute basics for beginners
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Fundamentals and usage
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="basics.html">
   NumPy fundamentals
  </a>
 </li>
</ul>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="numpy-for-matlab-users.html">
   NumPy for MATLAB users
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://numpy.org/numpy-tutorials/features.html">
   NumPy Tutorials
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="howtos_index.html">
   NumPy How Tos
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Advanced usage and interoperability
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="building.html">
   Building from source
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="c-info.html">
   Using NumPy C-API
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="c-info.how-to-extend.html">
     How to extend NumPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="c-info.python-as-glue.html">
     Using Python as glue
    </a>
   </li>
   <li class="toctree-l2 current active">
    <a class="current reference internal" href="#">
     Writing your own ufunc
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="c-info.beyond-basics.html">
     Beyond the Basics
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../f2py/index.html">
   F2PY user guide and reference manual
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../dev/underthehood.html">
   Under-the-hood documentation for developers
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="basics.interoperability.html">
   Interoperability with NumPy
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Extras
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../glossary.html">
   Glossary
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../release.html">
   Release notes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../license.html">
   NumPy license
  </a>
 </li>
</ul>

  </div>
</nav>
  </div>
  <div class="sidebar-end-items">
  </div>
</div>


          


<div class="bd-sidebar-secondary d-none d-xl-block col-xl-2 bd-toc">
  
    
    <div class="toc-item">
      
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#creating-a-new-universal-function">
   Creating a new universal function
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-non-ufunc-extension">
   Example Non-ufunc extension
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-numpy-ufunc-for-one-dtype">
   Example NumPy ufunc for one dtype
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-numpy-ufunc-with-multiple-dtypes">
   Example NumPy ufunc with multiple dtypes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-numpy-ufunc-with-multiple-arguments-return-values">
   Example NumPy ufunc with multiple arguments/return values
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-numpy-ufunc-with-structured-array-dtype-arguments">
   Example NumPy ufunc with structured array dtype arguments
  </a>
 </li>
</ul>

</nav>
    </div>
    
    <div class="toc-item">
      
    </div>
    
  
</div>


          
          
          <div class="bd-content col-12 col-md-9 col-xl-7">
              
              <article class="bd-article" role="main">
                
  <section id="writing-your-own-ufunc">
<h1>Writing your own ufunc<a class="headerlink" href="#writing-your-own-ufunc" title="Permalink to this heading">#</a></h1>
<div class="line-block">
<div class="line">I have the Power!</div>
<div class="line">— <em>He-Man</em></div>
</div>
<section id="creating-a-new-universal-function">
<span id="sec-creating-a-new"></span><h2>Creating a new universal function<a class="headerlink" href="#creating-a-new-universal-function" title="Permalink to this heading">#</a></h2>
<p id="index-0">Before reading this, it may help to familiarize yourself with the basics
of C extensions for Python by reading/skimming the tutorials in Section 1
of <a class="reference external" href="https://docs.python.org/extending/index.html">Extending and Embedding the Python Interpreter</a> and in <a class="reference internal" href="c-info.how-to-extend.html"><span class="doc">How to extend
NumPy</span></a></p>
<p>The umath module is a computer-generated C-module that creates many
ufuncs. It provides a great many examples of how to create a universal
function. Creating your own ufunc that will make use of the ufunc
machinery is not difficult either. Suppose you have a function that
you want to operate element-by-element over its inputs. By creating a
new ufunc you will obtain a function that handles</p>
<ul class="simple">
<li><p>broadcasting</p></li>
<li><p>N-dimensional looping</p></li>
<li><p>automatic type-conversions with minimal memory usage</p></li>
<li><p>optional output arrays</p></li>
</ul>
<p>It is not difficult to create your own ufunc. All that is required is
a 1-d loop for each data-type you want to support. Each 1-d loop must
have a specific signature, and only ufuncs for fixed-size data-types
can be used. The function call used to create a new ufunc to work on
built-in data-types is given below. A different mechanism is used to
register ufuncs for user-defined data-types.</p>
<p>In the next several sections we give example code that can be
easily modified to create your own ufuncs. The examples are
successively more complete or complicated versions of the logit
function, a common function in statistical modeling. Logit is also
interesting because, due to the magic of IEEE standards (specifically
IEEE 754), all of the logit functions created below
automatically have the following behavior.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">logit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="go">-inf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">inf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">nan</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">logit</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
<span class="go">nan</span>
</pre></div>
</div>
<p>This is wonderful because the function writer doesn’t have to
manually propagate infs or nans.</p>
</section>
<section id="example-non-ufunc-extension">
<span id="sec-non-numpy-example"></span><h2>Example Non-ufunc extension<a class="headerlink" href="#example-non-ufunc-extension" title="Permalink to this heading">#</a></h2>
<p id="index-1">For comparison and general edification of the reader we provide
a simple implementation of a C extension of <code class="docutils literal notranslate"><span class="pre">logit</span></code> that uses no
numpy.</p>
<p>To do this we need two files. The first is the C file which contains
the actual code, and the second is the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file used to create
the module.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * spammodule.c</span>
<span class="cm"> * This is the C code for a non-numpy Python extension to</span>
<span class="cm"> * define the logit function, where logit(p) = log(p/(1-p)).</span>
<span class="cm"> * This function will not work on numpy arrays automatically.</span>
<span class="cm"> * numpy.vectorize must be called in python to generate</span>
<span class="cm"> * a numpy-friendly function.</span>
<span class="cm"> *</span>
<span class="cm"> * Details explaining the Python-C API can be found under</span>
<span class="cm"> * &#39;Extending and Embedding&#39; and &#39;Python/C API&#39; at</span>
<span class="cm"> * docs.python.org .</span>
<span class="cm"> */</span><span class="w"></span>


<span class="cm">/* This declares the logit function */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="nf">spam_logit</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">);</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm"> * This tells Python what methods this module has.</span>
<span class="cm"> * See the Python-C API for more information.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="n">PyMethodDef</span><span class="w"> </span><span class="n">SpamMethods</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="s">&quot;logit&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">spam_logit</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="n">METH_VARARGS</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;compute logit&quot;</span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cm">/*</span>
<span class="cm"> * This actually defines the logit function for</span>
<span class="cm"> * input args from Python.</span>
<span class="cm"> */</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="nf">spam_logit</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* This parses the Python argument into a double */</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* THE ACTUAL LOGIT FUNCTION */</span><span class="w"></span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="cm">/*This builds the answer back into a python object */</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">p</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* This initiates the module using the above definitions. */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PyModuleDef</span><span class="w"> </span><span class="n">moduledef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;spam&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">-1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">SpamMethods</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="n">PyMODINIT_FUNC</span><span class="w"> </span><span class="nf">PyInit_spam</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moduledef</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>To use the <code class="docutils literal notranslate"><span class="pre">setup.py</span> <span class="pre">file</span></code>, place <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> and <code class="docutils literal notranslate"><span class="pre">spammodule.c</span></code>
in the same folder. Then <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">build</span></code> will build the module to
import, or <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span></code> will install the module to your
site-packages directory.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    setup.py file for spammodule.c</span>

<span class="sd">    Calling</span>
<span class="sd">    $python setup.py build_ext --inplace</span>
<span class="sd">    will build the extension library in the current file.</span>

<span class="sd">    Calling</span>
<span class="sd">    $python setup.py build</span>
<span class="sd">    will build a file that looks like ./build/lib*, where</span>
<span class="sd">    lib* is a file that begins with lib. The library will</span>
<span class="sd">    be in this file and end with a C library extension,</span>
<span class="sd">    such as .so</span>

<span class="sd">    Calling</span>
<span class="sd">    $python setup.py install</span>
<span class="sd">    will install the module in your site-packages file.</span>

<span class="sd">    See the distutils section of</span>
<span class="sd">    &#39;Extending and Embedding the Python Interpreter&#39;</span>
<span class="sd">    at docs.python.org for more information.</span>
<span class="sd">&#39;&#39;&#39;</span>


<span class="kn">from</span> <span class="nn">distutils.core</span> <span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span>

<span class="n">module1</span> <span class="o">=</span> <span class="n">Extension</span><span class="p">(</span><span class="s1">&#39;spam&#39;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;spammodule.c&#39;</span><span class="p">],</span>
                        <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;/usr/local/lib&#39;</span><span class="p">])</span>

<span class="n">setup</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;spam&#39;</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="s1">&#39;1.0&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;This is my spam package&#39;</span><span class="p">,</span>
        <span class="n">ext_modules</span> <span class="o">=</span> <span class="p">[</span><span class="n">module1</span><span class="p">])</span>
</pre></div>
</div>
</div></blockquote>
<p>Once the spam module is imported into python, you can call logit
via <code class="docutils literal notranslate"><span class="pre">spam.logit</span></code>. Note that the function used above cannot be applied
as-is to numpy arrays. To do so we must call <a class="reference internal" href="../reference/generated/numpy.vectorize.html#numpy.vectorize" title="numpy.vectorize"><code class="xref py py-func docutils literal notranslate"><span class="pre">numpy.vectorize</span></code></a>
on it. For example, if a python interpreter is opened in the file containing
the spam library or spam has been installed, one can perform the
following commands:</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">spam</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spam</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="go">-inf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spam</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">inf</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spam</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="go">0.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">spam</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">TypeError: only length-1 arrays can be converted to Python scalars</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">spam</span><span class="o">.</span><span class="n">logit</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="go">array([       -inf, -2.07944154, -1.25276297, -0.69314718, -0.22314355,</span>
<span class="go">    0.22314355,  0.69314718,  1.25276297,  2.07944154,         inf])</span>
</pre></div>
</div>
<p>THE RESULTING LOGIT FUNCTION IS NOT FAST! <code class="docutils literal notranslate"><span class="pre">numpy.vectorize</span></code> simply
loops over <code class="docutils literal notranslate"><span class="pre">spam.logit</span></code>. The loop is done at the C level, but the numpy
array is constantly being parsed and build back up. This is expensive.
When the author compared <code class="docutils literal notranslate"><span class="pre">numpy.vectorize(spam.logit)</span></code> against the
logit ufuncs constructed below, the logit ufuncs were almost exactly
4 times faster. Larger or smaller speedups are, of course, possible
depending on the nature of the function.</p>
</section>
<section id="example-numpy-ufunc-for-one-dtype">
<span id="sec-numpy-one-loop"></span><h2>Example NumPy ufunc for one dtype<a class="headerlink" href="#example-numpy-ufunc-for-one-dtype" title="Permalink to this heading">#</a></h2>
<p id="index-2">For simplicity we give a ufunc for a single dtype, the <code class="docutils literal notranslate"><span class="pre">'f8'</span></code>
<code class="docutils literal notranslate"><span class="pre">double</span></code>. As in the previous section, we first give the <code class="docutils literal notranslate"><span class="pre">.c</span></code> file
and then the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file used to create the module containing the
ufunc.</p>
<p>The place in the code corresponding to the actual computations for
the ufunc are marked with <code class="docutils literal notranslate"><span class="pre">/\*</span> <span class="pre">BEGIN</span> <span class="pre">main</span> <span class="pre">ufunc</span> <span class="pre">computation</span> <span class="pre">\*/</span></code> and
<code class="docutils literal notranslate"><span class="pre">/\*</span> <span class="pre">END</span> <span class="pre">main</span> <span class="pre">ufunc</span> <span class="pre">computation</span> <span class="pre">\*/</span></code>. The code in between those lines is
the primary thing that must be changed to create your own ufunc.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;numpy/ndarraytypes.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;numpy/ufuncobject.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;numpy/npy_3kcompat.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * single_type_logit.c</span>
<span class="cm"> * This is the C code for creating your own</span>
<span class="cm"> * NumPy ufunc for a logit function.</span>
<span class="cm"> *</span>
<span class="cm"> * In this code we only define the ufunc for</span>
<span class="cm"> * a single dtype. The computations that must</span>
<span class="cm"> * be replaced to create a ufunc for</span>
<span class="cm"> * a different function are marked with BEGIN</span>
<span class="cm"> * and END.</span>
<span class="cm"> *</span>
<span class="cm"> * Details explaining the Python-C API can be found under</span>
<span class="cm"> * &#39;Extending and Embedding&#39; and &#39;Python/C API&#39; at</span>
<span class="cm"> * docs.python.org .</span>
<span class="cm"> */</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="n">PyMethodDef</span><span class="w"> </span><span class="n">LogitMethods</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cm">/* The loop definition must precede the PyMODINIT_FUNC. */</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">double_logit</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">dimensions</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">steps</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">in_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">out_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* BEGIN main ufunc computation */</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">in</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="p">((</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* END main ufunc computation */</span><span class="w"></span>

<span class="w">        </span><span class="n">in</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">in_step</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">out_step</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* This a pointer to the above function */</span><span class="w"></span>
<span class="n">PyUFuncGenericFunction</span><span class="w"> </span><span class="n">funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="o">&amp;</span><span class="n">double_logit</span><span class="p">};</span><span class="w"></span>

<span class="cm">/* These are the input and return dtypes of logit.*/</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">NPY_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_DOUBLE</span><span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PyModuleDef</span><span class="w"> </span><span class="n">moduledef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;npufunc&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">-1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">LogitMethods</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="n">PyMODINIT_FUNC</span><span class="w"> </span><span class="nf">PyInit_npufunc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">logit</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">import_array</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">import_umath</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moduledef</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">logit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyUFunc_FromFuncAndData</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">PyUFunc_None</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;logit&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="s">&quot;logit_docstring&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyModule_GetDict</span><span class="p">(</span><span class="n">m</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">PyDict_SetItemString</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;logit&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">logit</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">logit</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>This is a <code class="docutils literal notranslate"><span class="pre">setup.py</span> <span class="pre">file</span></code> for the above code. As before, the module
can be build via calling <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">build</span></code> at the command prompt,
or installed to site-packages via <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span></code>. The module
can also be placed into a local folder e.g. <code class="docutils literal notranslate"><span class="pre">npufunc_directory</span></code> below
using <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">build_ext</span> <span class="pre">--inplace</span></code>.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    setup.py file for single_type_logit.c</span>
<span class="sd">    Note that since this is a numpy extension</span>
<span class="sd">    we use numpy.distutils instead of</span>
<span class="sd">    distutils from the python standard library.</span>

<span class="sd">    Calling</span>
<span class="sd">    $python setup.py build_ext --inplace</span>
<span class="sd">    will build the extension library in the npufunc_directory.</span>

<span class="sd">    Calling</span>
<span class="sd">    $python setup.py build</span>
<span class="sd">    will build a file that looks like ./build/lib*, where</span>
<span class="sd">    lib* is a file that begins with lib. The library will</span>
<span class="sd">    be in this file and end with a C library extension,</span>
<span class="sd">    such as .so</span>

<span class="sd">    Calling</span>
<span class="sd">    $python setup.py install</span>
<span class="sd">    will install the module in your site-packages file.</span>

<span class="sd">    See the distutils section of</span>
<span class="sd">    &#39;Extending and Embedding the Python Interpreter&#39;</span>
<span class="sd">    at docs.python.org  and the documentation</span>
<span class="sd">    on numpy.distutils for more information.</span>
<span class="sd">&#39;&#39;&#39;</span>


<span class="k">def</span> <span class="nf">configuration</span><span class="p">(</span><span class="n">parent_package</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">top_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.distutils.misc_util</span> <span class="kn">import</span> <span class="n">Configuration</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">(</span><span class="s1">&#39;npufunc_directory&#39;</span><span class="p">,</span>
                           <span class="n">parent_package</span><span class="p">,</span>
                           <span class="n">top_path</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span><span class="s1">&#39;npufunc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;single_type_logit.c&#39;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">config</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">numpy.distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
    <span class="n">setup</span><span class="p">(</span><span class="n">configuration</span><span class="o">=</span><span class="n">configuration</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>After the above has been installed, it can be imported and used as follows.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">npufunc</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">npufunc</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="go">0.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">npufunc</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="go">array([       -inf, -1.09861229,  0.        ,  1.09861229,         inf])</span>
</pre></div>
</div>
</section>
<section id="example-numpy-ufunc-with-multiple-dtypes">
<span id="sec-numpy-many-loop"></span><h2>Example NumPy ufunc with multiple dtypes<a class="headerlink" href="#example-numpy-ufunc-with-multiple-dtypes" title="Permalink to this heading">#</a></h2>
<p id="index-3">We finally give an example of a full ufunc, with inner loops for
half-floats, floats, doubles, and long doubles. As in the previous
sections we first give the <code class="docutils literal notranslate"><span class="pre">.c</span></code> file and then the corresponding
<code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file.</p>
<p>The places in the code corresponding to the actual computations for
the ufunc are marked with <code class="docutils literal notranslate"><span class="pre">/\*</span> <span class="pre">BEGIN</span> <span class="pre">main</span> <span class="pre">ufunc</span> <span class="pre">computation</span> <span class="pre">\*/</span></code> and
<code class="docutils literal notranslate"><span class="pre">/\*</span> <span class="pre">END</span> <span class="pre">main</span> <span class="pre">ufunc</span> <span class="pre">computation</span> <span class="pre">\*/</span></code>. The code in between those lines
is the primary thing that must be changed to create your own ufunc.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;numpy/ndarraytypes.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;numpy/ufuncobject.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;numpy/halffloat.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * multi_type_logit.c</span>
<span class="cm"> * This is the C code for creating your own</span>
<span class="cm"> * NumPy ufunc for a logit function.</span>
<span class="cm"> *</span>
<span class="cm"> * Each function of the form type_logit defines the</span>
<span class="cm"> * logit function for a different numpy dtype. Each</span>
<span class="cm"> * of these functions must be modified when you</span>
<span class="cm"> * create your own ufunc. The computations that must</span>
<span class="cm"> * be replaced to create a ufunc for</span>
<span class="cm"> * a different function are marked with BEGIN</span>
<span class="cm"> * and END.</span>
<span class="cm"> *</span>
<span class="cm"> * Details explaining the Python-C API can be found under</span>
<span class="cm"> * &#39;Extending and Embedding&#39; and &#39;Python/C API&#39; at</span>
<span class="cm"> * docs.python.org .</span>
<span class="cm"> *</span>
<span class="cm"> */</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="n">PyMethodDef</span><span class="w"> </span><span class="n">LogitMethods</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cm">/* The loop definitions must precede the PyMODINIT_FUNC. */</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">long_double_logit</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">dimensions</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">steps</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">in_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">out_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* BEGIN main ufunc computation */</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">in</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="p">((</span><span class="kt">long</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logl</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* END main ufunc computation */</span><span class="w"></span>

<span class="w">        </span><span class="n">in</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">in_step</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">out_step</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">double_logit</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">dimensions</span><span class="p">,</span><span class="w"></span>
<span class="w">                         </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">steps</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">in_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">out_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* BEGIN main ufunc computation */</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">in</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="p">((</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* END main ufunc computation */</span><span class="w"></span>

<span class="w">        </span><span class="n">in</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">in_step</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">out_step</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">float_logit</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">dimensions</span><span class="p">,</span><span class="w"></span>
<span class="w">                       </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">steps</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">in_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">out_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* BEGIN main ufunc computation */</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">in</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="p">((</span><span class="kt">float</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logf</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* END main ufunc computation */</span><span class="w"></span>

<span class="w">        </span><span class="n">in</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">in_step</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">out_step</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">half_float_logit</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">dimensions</span><span class="p">,</span><span class="w"></span>
<span class="w">                            </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">steps</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">in_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">out_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="kt">float</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="cm">/* BEGIN main ufunc computation */</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">npy_half_to_float</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">npy_half</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">in</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">logf</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="p">((</span><span class="n">npy_half</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">out</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">npy_float_to_half</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* END main ufunc computation */</span><span class="w"></span>

<span class="w">        </span><span class="n">in</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">in_step</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">out</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">out_step</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>


<span class="cm">/*This gives pointers to the above functions*/</span><span class="w"></span>
<span class="n">PyUFuncGenericFunction</span><span class="w"> </span><span class="n">funcs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="o">&amp;</span><span class="n">half_float_logit</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="o">&amp;</span><span class="n">float_logit</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="o">&amp;</span><span class="n">double_logit</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="o">&amp;</span><span class="n">long_double_logit</span><span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">types</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">NPY_HALF</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_HALF</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">NPY_FLOAT</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_FLOAT</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">NPY_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_DOUBLE</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">NPY_LONGDOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_LONGDOUBLE</span><span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PyModuleDef</span><span class="w"> </span><span class="n">moduledef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;npufunc&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">-1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">LogitMethods</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="n">PyMODINIT_FUNC</span><span class="w"> </span><span class="nf">PyInit_npufunc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">logit</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">import_array</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">import_umath</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moduledef</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">logit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyUFunc_FromFuncAndData</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">PyUFunc_None</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;logit&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="s">&quot;logit_docstring&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyModule_GetDict</span><span class="p">(</span><span class="n">m</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">PyDict_SetItemString</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;logit&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">logit</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">logit</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p>This is a <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file for the above code. As before, the module
can be build via calling <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">build</span></code> at the command prompt,
or installed to site-packages via <code class="docutils literal notranslate"><span class="pre">python</span> <span class="pre">setup.py</span> <span class="pre">install</span></code>.</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    setup.py file for multi_type_logit.c</span>
<span class="sd">    Note that since this is a numpy extension</span>
<span class="sd">    we use numpy.distutils instead of</span>
<span class="sd">    distutils from the python standard library.</span>

<span class="sd">    Calling</span>
<span class="sd">    $python setup.py build_ext --inplace</span>
<span class="sd">    will build the extension library in the current file.</span>

<span class="sd">    Calling</span>
<span class="sd">    $python setup.py build</span>
<span class="sd">    will build a file that looks like ./build/lib*, where</span>
<span class="sd">    lib* is a file that begins with lib. The library will</span>
<span class="sd">    be in this file and end with a C library extension,</span>
<span class="sd">    such as .so</span>

<span class="sd">    Calling</span>
<span class="sd">    $python setup.py install</span>
<span class="sd">    will install the module in your site-packages file.</span>

<span class="sd">    See the distutils section of</span>
<span class="sd">    &#39;Extending and Embedding the Python Interpreter&#39;</span>
<span class="sd">    at docs.python.org  and the documentation</span>
<span class="sd">    on numpy.distutils for more information.</span>
<span class="sd">&#39;&#39;&#39;</span>


<span class="k">def</span> <span class="nf">configuration</span><span class="p">(</span><span class="n">parent_package</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">top_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">numpy.distutils.misc_util</span> <span class="kn">import</span> <span class="n">Configuration</span><span class="p">,</span> <span class="n">get_info</span>

    <span class="c1">#Necessary for the half-float d-type.</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">get_info</span><span class="p">(</span><span class="s1">&#39;npymath&#39;</span><span class="p">)</span>

    <span class="n">config</span> <span class="o">=</span> <span class="n">Configuration</span><span class="p">(</span><span class="s1">&#39;npufunc_directory&#39;</span><span class="p">,</span>
                            <span class="n">parent_package</span><span class="p">,</span>
                            <span class="n">top_path</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span><span class="s1">&#39;npufunc&#39;</span><span class="p">,</span>
                            <span class="p">[</span><span class="s1">&#39;multi_type_logit.c&#39;</span><span class="p">],</span>
                            <span class="n">extra_info</span><span class="o">=</span><span class="n">info</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">config</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">numpy.distutils.core</span> <span class="kn">import</span> <span class="n">setup</span>
    <span class="n">setup</span><span class="p">(</span><span class="n">configuration</span><span class="o">=</span><span class="n">configuration</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
<p>After the above has been installed, it can be imported and used as follows.</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">npufunc</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">npufunc</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
<span class="go">0.0</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">npufunc</span><span class="o">.</span><span class="n">logit</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="go">array([       -inf, -1.09861229,  0.        ,  1.09861229,         inf])</span>
</pre></div>
</div>
</section>
<section id="example-numpy-ufunc-with-multiple-arguments-return-values">
<span id="sec-numpy-many-arg"></span><h2>Example NumPy ufunc with multiple arguments/return values<a class="headerlink" href="#example-numpy-ufunc-with-multiple-arguments-return-values" title="Permalink to this heading">#</a></h2>
<p>Our final example is a ufunc with multiple arguments. It is a modification
of the code for a logit ufunc for data with a single dtype. We
compute <code class="docutils literal notranslate"><span class="pre">(A</span> <span class="pre">*</span> <span class="pre">B,</span> <span class="pre">logit(A</span> <span class="pre">*</span> <span class="pre">B))</span></code>.</p>
<p>We only give the C code as the setup.py file is exactly the same as
the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file in <a class="reference internal" href="#example-numpy-ufunc-for-one-dtype">Example NumPy ufunc for one dtype</a>, except that
the line</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span><span class="s1">&#39;npufunc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;single_type_logit.c&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div></blockquote>
<p>is replaced with</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span><span class="s1">&#39;npufunc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;multi_arg_logit.c&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div></blockquote>
<p>The C file is given below. The ufunc generated takes two arguments <code class="docutils literal notranslate"><span class="pre">A</span></code>
and <code class="docutils literal notranslate"><span class="pre">B</span></code>. It returns a tuple whose first element is <code class="docutils literal notranslate"><span class="pre">A</span> <span class="pre">*</span> <span class="pre">B</span></code> and whose second
element is <code class="docutils literal notranslate"><span class="pre">logit(A</span> <span class="pre">*</span> <span class="pre">B)</span></code>. Note that it automatically supports broadcasting,
as well as all other properties of a ufunc.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;numpy/ndarraytypes.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;numpy/ufuncobject.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;numpy/halffloat.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * multi_arg_logit.c</span>
<span class="cm"> * This is the C code for creating your own</span>
<span class="cm"> * NumPy ufunc for a multiple argument, multiple</span>
<span class="cm"> * return value ufunc. The places where the</span>
<span class="cm"> * ufunc computation is carried out are marked</span>
<span class="cm"> * with comments.</span>
<span class="cm"> *</span>
<span class="cm"> * Details explaining the Python-C API can be found under</span>
<span class="cm"> * &#39;Extending and Embedding&#39; and &#39;Python/C API&#39; at</span>
<span class="cm"> * docs.python.org.</span>
<span class="cm"> */</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="n">PyMethodDef</span><span class="w"> </span><span class="n">LogitMethods</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cm">/* The loop definition must precede the PyMODINIT_FUNC. */</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">double_logitprod</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">dimensions</span><span class="p">,</span><span class="w"></span>
<span class="w">                             </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">steps</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">in1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">in2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">out1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="o">*</span><span class="n">out2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">in1_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">in2_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">out1_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">out2_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* BEGIN main ufunc computation */</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">in1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">in2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="p">((</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">out1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="o">*</span><span class="p">((</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">out2</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">log</span><span class="p">(</span><span class="n">tmp</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">tmp</span><span class="p">));</span><span class="w"></span>
<span class="w">        </span><span class="cm">/* END main ufunc computation */</span><span class="w"></span>

<span class="w">        </span><span class="n">in1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">in1_step</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">in2</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">in2_step</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">out1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">out1_step</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">out2</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">out2_step</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/*This a pointer to the above function*/</span><span class="w"></span>
<span class="n">PyUFuncGenericFunction</span><span class="w"> </span><span class="n">funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="o">&amp;</span><span class="n">double_logitprod</span><span class="p">};</span><span class="w"></span>

<span class="cm">/* These are the input and return dtypes of logit.*/</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">types</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">NPY_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_DOUBLE</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">NPY_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_DOUBLE</span><span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PyModuleDef</span><span class="w"> </span><span class="n">moduledef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;npufunc&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">-1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">LogitMethods</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="n">PyMODINIT_FUNC</span><span class="w"> </span><span class="nf">PyInit_npufunc</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">logit</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">import_array</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">import_umath</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moduledef</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">logit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyUFunc_FromFuncAndData</span><span class="p">(</span><span class="n">funcs</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">types</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="n">PyUFunc_None</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;logit&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="s">&quot;logit_docstring&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyModule_GetDict</span><span class="p">(</span><span class="n">m</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">PyDict_SetItemString</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;logit&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">logit</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">logit</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="example-numpy-ufunc-with-structured-array-dtype-arguments">
<span id="sec-numpy-struct-dtype"></span><h2>Example NumPy ufunc with structured array dtype arguments<a class="headerlink" href="#example-numpy-ufunc-with-structured-array-dtype-arguments" title="Permalink to this heading">#</a></h2>
<p>This example shows how to create a ufunc for a structured array dtype.
For the example we show a trivial ufunc for adding two arrays with dtype
<code class="docutils literal notranslate"><span class="pre">'u8,u8,u8'</span></code>. The process is a bit different from the other examples since
a call to <a class="reference internal" href="../reference/c-api/ufunc.html#c.PyUFunc_FromFuncAndData" title="PyUFunc_FromFuncAndData"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyUFunc_FromFuncAndData</span></code></a> doesn’t fully register ufuncs for
custom dtypes and structured array dtypes. We need to also call
<a class="reference internal" href="../reference/c-api/ufunc.html#c.PyUFunc_RegisterLoopForDescr" title="PyUFunc_RegisterLoopForDescr"><code class="xref c c-func docutils literal notranslate"><span class="pre">PyUFunc_RegisterLoopForDescr</span></code></a> to finish setting up the ufunc.</p>
<p>We only give the C code as the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file is exactly the same as
the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file in <a class="reference internal" href="#example-numpy-ufunc-for-one-dtype">Example NumPy ufunc for one dtype</a>, except that
the line</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span><span class="s1">&#39;npufunc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;single_type_logit.c&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div></blockquote>
<p>is replaced with</p>
<blockquote>
<div><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">config</span><span class="o">.</span><span class="n">add_extension</span><span class="p">(</span><span class="s1">&#39;npufunc&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;add_triplet.c&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div></blockquote>
<p>The C file is given below.</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define PY_SSIZE_T_CLEAN</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;numpy/ndarraytypes.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;numpy/ufuncobject.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;numpy/npy_3kcompat.h&quot;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * add_triplet.c</span>
<span class="cm"> * This is the C code for creating your own</span>
<span class="cm"> * NumPy ufunc for a structured array dtype.</span>
<span class="cm"> *</span>
<span class="cm"> * Details explaining the Python-C API can be found under</span>
<span class="cm"> * &#39;Extending and Embedding&#39; and &#39;Python/C API&#39; at</span>
<span class="cm"> * docs.python.org.</span>
<span class="cm"> */</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="n">PyMethodDef</span><span class="w"> </span><span class="n">StructUfuncTestMethods</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">}</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="cm">/* The loop definition must precede the PyMODINIT_FUNC. */</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">add_uint64_triplet</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">dimensions</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">steps</span><span class="p">,</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">is1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">is2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">os</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">steps</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="o">*</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">z</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">i1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">i2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>

<span class="w">        </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">i1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">i2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">uint64_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">op</span><span class="p">;</span><span class="w"></span>

<span class="w">        </span><span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"></span>
<span class="w">        </span><span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"></span>

<span class="w">        </span><span class="n">i1</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">is1</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">i2</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">is2</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">op</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">os</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="cm">/* This a pointer to the above function */</span><span class="w"></span>
<span class="n">PyUFuncGenericFunction</span><span class="w"> </span><span class="n">funcs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="o">&amp;</span><span class="n">add_uint64_triplet</span><span class="p">};</span><span class="w"></span>

<span class="cm">/* These are the input and return dtypes of add_uint64_triplet. */</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">types</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">NPY_UINT64</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_UINT64</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_UINT64</span><span class="p">};</span><span class="w"></span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PyModuleDef</span><span class="w"> </span><span class="n">moduledef</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;struct_ufunc_test&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="mi">-1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">StructUfuncTestMethods</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="nb">NULL</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>

<span class="n">PyMODINIT_FUNC</span><span class="w"> </span><span class="nf">PyInit_struct_ufunc_test</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"></span>
<span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">add_triplet</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">d</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">dtype_dict</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">PyArray_Descr</span><span class="w"> </span><span class="o">*</span><span class="n">dtype</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">PyArray_Descr</span><span class="w"> </span><span class="o">*</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span><span class="w"></span>

<span class="w">    </span><span class="n">import_array</span><span class="p">();</span><span class="w"></span>
<span class="w">    </span><span class="n">import_umath</span><span class="p">();</span><span class="w"></span>

<span class="w">    </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">moduledef</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">m</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Create a new ufunc object */</span><span class="w"></span>
<span class="w">    </span><span class="n">add_triplet</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyUFunc_FromFuncAndData</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">PyUFunc_None</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;add_triplet&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="s">&quot;add_triplet_docstring&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">dtype_dict</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;[(s, s), (s, s), (s, s)]&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">                               </span><span class="s">&quot;f0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;u8&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;f1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;u8&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;f2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;u8&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">PyArray_DescrConverter</span><span class="p">(</span><span class="n">dtype_dict</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dtype</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">dtype_dict</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dtype</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">dtypes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dtype</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">dtypes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dtype</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="cm">/* Register ufunc for structured dtype */</span><span class="w"></span>
<span class="w">    </span><span class="n">PyUFunc_RegisterLoopForDescr</span><span class="p">(</span><span class="n">add_triplet</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">dtype</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="o">&amp;</span><span class="n">add_uint64_triplet</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">dtypes</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyModule_GetDict</span><span class="p">(</span><span class="n">m</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="n">PyDict_SetItemString</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;add_triplet&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">add_triplet</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">add_triplet</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">m</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
<p id="index-4">The returned ufunc object is a callable Python object. It should be
placed in a (module) dictionary under the same name as was used in the
name argument to the ufunc-creation routine. The following example is
adapted from the umath module</p>
<blockquote>
<div><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">PyUFuncGenericFunction</span><span class="w"> </span><span class="n">atan2_functions</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="n">PyUFunc_ff_f</span><span class="p">,</span><span class="w"> </span><span class="n">PyUFunc_dd_d</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="n">PyUFunc_gg_g</span><span class="p">,</span><span class="w"> </span><span class="n">PyUFunc_OO_O_method</span><span class="p">};</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">atan2_data</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                      </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">atan2f</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">atan2</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">atan2l</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="s">&quot;arctan2&quot;</span><span class="p">};</span><span class="w"></span>
<span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">atan2_signatures</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">              </span><span class="n">NPY_FLOAT</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_FLOAT</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_FLOAT</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">NPY_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_DOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_DOUBLE</span><span class="p">,</span><span class="w"></span>
<span class="w">              </span><span class="n">NPY_LONGDOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_LONGDOUBLE</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_LONGDOUBLE</span><span class="w"></span>
<span class="w">              </span><span class="n">NPY_OBJECT</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_OBJECT</span><span class="p">,</span><span class="w"> </span><span class="n">NPY_OBJECT</span><span class="p">};</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="cm">/* in the module initialization code */</span><span class="w"></span>
<span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">dict</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">module</span><span class="p">;</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="n">dict</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyModule_GetDict</span><span class="p">(</span><span class="n">module</span><span class="p">);</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
<span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyUFunc_FromFuncAndData</span><span class="p">(</span><span class="n">atan2_functions</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">atan2_data</span><span class="p">,</span><span class="w"> </span><span class="n">atan2_signatures</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">PyUFunc_None</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;arctan2&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="s">&quot;a safe and correct arctan(x1/x2)&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="n">PyDict_SetItemString</span><span class="p">(</span><span class="n">dict</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;arctan2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">);</span><span class="w"></span>
<span class="n">Py_DECREF</span><span class="p">(</span><span class="n">f</span><span class="p">);</span><span class="w"></span>
<span class="p">...</span><span class="w"></span>
</pre></div>
</div>
</div></blockquote>
</section>
</section>


              </article>
              

              
              <footer class="bd-footer-article">
                  <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="c-info.python-as-glue.html" title="previous page">
      <i class="fas fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Using Python as glue</p>
      </div>
  </a>
  <a class='right-next' id="next-link" href="c-info.beyond-basics.html" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">Beyond the Basics</p>
  </div>
  <i class="fas fa-angle-right"></i>
  </a>
</div>
              </footer>
              
          </div>
          
      </div>
    </div>

  
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=92025949c220c2e29695"></script>

<footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    <p class="copyright">
    &copy; Copyright 2008-2022, NumPy Developers.<br>
</p>
  </div>
  
  <div class="footer-item">
    <p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>
  </div>
  
</div>
</footer>
  </body>
</html>